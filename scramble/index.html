<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Scramble Learning Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* Light Sky Blue Background */
        }
        /* Custom colors for a playful look */
        .color-primary { color: #06b6d4; /* Sky 500 */ }
        .bg-primary { background-color: #06b6d4; }
        .border-primary { border-color: #06b6d4; }

        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15), 0 0 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        .button-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        .scrambled-char {
            display: inline-block;
            min-width: 2.5rem; /* Slightly larger */
            text-align: center;
            font-size: 2rem; /* Larger font */
            font-weight: 800;
            border-bottom: 4px solid #06b6d4; /* Sky 500 border */
            margin: 0 0.35rem;
            color: #164e63; /* Dark Teal */
            padding-bottom: 0.25rem;
        }
        .hint-letter {
            color: #10b981; /* Emerald 500 for hints */
            font-weight: 900;
        }
        #word-input {
            text-transform: uppercase;
        }
        .loader-dots {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loader-dots div {
            width: 12px;
            height: 12px;
            background-color: #06b6d4; /* Sky 500 */
            border-radius: 50%;
            margin: 0 6px;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .loader-dots div:nth-child(2) {
            animation-delay: -0.4s;
        }
        .loader-dots div:nth-child(3) {
            animation-delay: -0.8s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div id="app-container" class="w-full max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold color-primary">üß† Word Scramble Challenge!</h1>
            <p class="text-gray-500 mt-2 text-xl font-medium">Let's learn new words, their meanings, and spelling!</p>
        </header>

        <div id="config-screen" class="card p-6 md:p-10 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Ready to Start?</h2>
            <p class="text-gray-600 mb-6 text-lg">Type the words you want to practice below. Separate them with commas (like: **cat, dog, happy, science**).</p>
            <textarea id="word-list-input" rows="4" class="w-full p-3 border-2 border-sky-300 rounded-xl focus:ring-sky-500 focus:border-sky-500 transition duration-150 text-lg" placeholder="Enter words here (e.g., light, friend, school, genius)"></textarea>
            <button id="start-game-button" class="w-full mt-4 button-primary bg-sky-500 text-white py-4 rounded-xl font-extrabold text-xl hover:bg-sky-600" onclick="App.loadWords()">
                Go, Go, Go! Start the Game! üöÄ
            </button>
        </div>

        <div id="game-screen" class="hidden">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 p-4 rounded-xl bg-sky-100 border-2 border-sky-300">
                <p class="text-2xl font-bold text-sky-800 mb-2 md:mb-0">Score: <span id="current-score" class="text-4xl ml-2 font-extrabold">0</span></p>
                <p class="text-xl font-medium text-gray-700">Word <span id="current-word-index" class="font-bold">1</span> of <span id="total-words">0</span></p>
            </div>

            <div id="word-panel" class="card p-6 md:p-10 text-center">
                <div id="loading-spinner" class="hidden text-center py-12">
                    <div class="loader-dots mb-4">
                        <div></div><div></div><div></div>
                    </div>
                    <p class="mt-4 text-sky-600 font-bold text-xl">Thinking up a clue and drawing a picture...</p>
                </div>

                <div id="game-content" class="hidden">
                    <div class="w-full h-48 sm:h-64 mb-6 rounded-xl overflow-hidden shadow-xl border-4 border-gray-100 bg-gray-100 flex items-center justify-center">
                        <img id="word-image" class="w-full h-full object-contain p-2" src="" alt="Image clue for the word" onerror="this.onerror=null; this.src='https://placehold.co/600x400/818CF8/FFFFFF?text=Picture+Clue+Is+Coming...';">
                    </div>

                    <div class="text-left mb-6 p-5 bg-yellow-100 rounded-xl border-l-4 border-amber-500 shadow-md">
                        <p class="text-lg font-extrabold text-amber-700 uppercase mb-1">üí° What does it mean?</p>
                        <p id="word-definition" class="text-xl font-medium text-gray-800"></p>
                        <p class="text-lg font-extrabold text-amber-700 uppercase mt-3 mb-1">üí¨ How to use it?</p>
                        <p id="word-clue" class="text-lg italic text-gray-700"></p>
                    </div>

                    <h2 id="scrambled-word-display" class="text-6xl font-extrabold tracking-widest text-gray-800 mb-8 flex justify-center flex-wrap">
                        </h2>

                    <div class="flex flex-col sm:flex-row gap-3 mb-6 items-center">
                        <input type="text" id="word-input" class="flex-grow p-4 border-4 border-sky-400 rounded-xl font-extrabold text-2xl text-center tracking-wider focus:ring-sky-500 focus:border-sky-500 placeholder-gray-400" placeholder="TYPE YOUR GUESS HERE">
                        <button id="submit-button" class="w-full sm:w-auto button-primary bg-sky-500 text-white py-4 px-8 rounded-xl font-extrabold text-xl hover:bg-sky-600 shadow-lg" onclick="App.checkGuess()">
                            CHECK ANSWER!
                        </button>
                    </div>

                    <div class="flex justify-center gap-4">
                        <button id="hint-button" class="button-primary bg-emerald-500 text-white py-3 px-6 rounded-xl font-bold hover:bg-emerald-600 disabled:opacity-50 text-lg shadow-md" onclick="App.applyHint()">
                            Need a Hint? (<span id="hints-remaining">3</span> left)
                        </button>
                    </div>
                </div>

                <div id="message-box" class="mt-6 p-4 text-center rounded-xl font-semibold hidden text-xl shadow-inner"></div>
            </div>
        </div>

        <div id="game-over-screen" class="hidden card p-10 text-center">
            <h2 class="text-5xl font-extrabold text-emerald-600 mb-4">üèÜ Fantastic Job! üèÜ</h2>
            <p class="text-2xl text-gray-700 mb-8">Your final score is an amazing <span id="final-score" class="text-emerald-700 font-extrabold text-5xl ml-2">0</span> points!</p>
            <p class="text-xl text-gray-600 mb-6 font-semibold">Let's review the words you learned:</p>
            <div id="review-list" class="text-left text-lg text-gray-600 mb-8 p-4 bg-gray-50 rounded-lg"></div>
            <button class="button-primary bg-sky-500 text-white py-4 px-8 rounded-xl font-extrabold text-xl hover:bg-sky-600" onclick="window.location.reload()">
                Start a New Challenge! üåà
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Global App object containing all game logic and state.
         */
        window.App = {
            // --- FIREBASE/API CONFIG ---
            db: null,
            auth: null,
            // üí° CRITICAL CHANGE 1: Set the single PROXY endpoint URL
            geminiApiUrl: '/api/generate', 
            // üí° CRITICAL CHANGE 2: Remove the Imagen URL and old API Key
            imagenApiUrl: '', // No longer needed
            // apiKey: '...', // Removed for security
            // --- GAME STATE ---
            words: [],          // Array of original words from input
            gameData: [],       // Array of objects holding word data, hints, etc.
            currentWordIndex: 0,
            score: 0,
            maxHints: 3,
            basePoints: 100,

            /**
             * Initializes Firebase and authenticates the user.
             */
            async initializeApp() {
                try {
                    // Initialize Firebase and Auth
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);
                    setLogLevel('Debug'); // Enable Firestore logging

                    if (initialAuthToken) {
                        await signInWithCustomToken(this.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(this.auth);
                    }
                } catch (error) {
                    console.error("Firebase initialization or authentication failed:", error);
                }
            },

            /**
             * Utility to handle exponential backoff for API calls.
             */
            async fetchWithRetry(url, options, maxRetries = 3) {
                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                        }
                        // The proxy returns a JSON object, so we return the JSON data
                        return await response.json(); 
                    } catch (error) {
                        console.warn(`Attempt ${attempt + 1} failed: ${error.message}. Retrying...`);
                        if (attempt === maxRetries - 1) throw error;
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            },

            /**
             * Scrambles a word while ensuring it's not the same as the original.
             * @param {string} word The word to scramble.
             * @returns {string} The scrambled word.
             */
            scrambleWord(word) {
                const arr = word.toUpperCase().split('');
                let scrambled = '';
                let attempts = 0;

                do {
                    // Fisher-Yates shuffle
                    for (let i = arr.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [arr[i], arr[j]] = [arr[j], arr[i]];
                    }
                    scrambled = arr.join('');
                    attempts++;
                } while (scrambled === word.toUpperCase() && attempts < 10); // Try up to 10 times

                return scrambled;
            },

            /**
             * Parses user input and initializes the game state.
             */
            loadWords() {
                const input = document.getElementById('word-list-input').value.trim();
                if (!input) {
                    this.showMessage("Oops! Please enter at least one word to start our fun challenge.", 'bg-red-200 text-red-800 border-2 border-red-400');
                    return;
                }

                this.words = input.split(',').map(w => w.trim().toUpperCase()).filter(w => w.length > 0 && /^[A-Z]+$/.test(w));

                if (this.words.length === 0) {
                    this.showMessage("Uh oh! I only see letters in English, please. Use commas to separate your words.", 'bg-red-200 text-red-800 border-2 border-red-400');
                    return;
                }

                // Initialize game data
                this.gameData = this.words.map(word => ({
                    original: word,
                    scrambled: this.scrambleWord(word),
                    definition: "Loading...",
                    clue: "Loading...",
                    imagePrompt: word, // Use the word as the initial prompt
                    currentGuess: Array(word.length).fill('_').join(''),
                    hintsUsed: 0,
                    isCorrect: false,
                    imageUrl: null,
                    loading: true
                }));

                this.currentWordIndex = 0;
                this.score = 0;
                this.updateScoreDisplay();

                // Transition to game screen
                document.getElementById('config-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                document.getElementById('total-words').textContent = this.words.length;

                this.startGame();
            },

            /**
             * Starts the game and handles the first word.
             */
            async startGame() {
                this.clearMessageBox();
                await this.fetchDataForCurrentWord();
                this.displayWord();
                document.getElementById('word-input').focus();
            },

            /**
             * üí° CRITICAL CHANGE 3: Rewritten to call the single proxy endpoint.
             * Fetches clues and image for the current word using the Vercel proxy.
             */
            async fetchDataForCurrentWord() {
                const currentData = this.gameData[this.currentWordIndex];
                const word = currentData.original;

                // Show loading state
                document.getElementById('game-content').classList.add('hidden');
                document.getElementById('loading-spinner').classList.remove('hidden');
                document.getElementById('submit-button').disabled = true;
                document.getElementById('hint-button').disabled = true;

                try {
                    // Call the single, secure proxy endpoint with the word as a query parameter
                    const data = await this.fetchWithRetry(`${this.geminiApiUrl}?word=${word}`, {
                        method: 'GET',
                        // CRUCIAL: No headers needed here, the proxy handles all authentication
                    });

                    // The proxy returns the combined data: definition, sentenceClue, and imageUrl
                    currentData.definition = data.definition;
                    currentData.clue = data.sentenceClue;
                    currentData.imageUrl = data.imageUrl; // This is the base64 Data URL
                    currentData.loading = false;
                    
                } catch (error) {
                    console.error("Error fetching data from secure proxy:", error);
                    currentData.loading = false;
                    currentData.definition = "Oh no, definition failed to load. Check Vercel logs!";
                    currentData.clue = "Oh no, sentence clue failed to load. Check Vercel logs!";
                    currentData.imageUrl = `https://placehold.co/600x400/B91C1C/FFFFFF?text=API+Proxy+Error`;
                }

                // Hide loading state
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('game-content').classList.remove('hidden');
                document.getElementById('submit-button').disabled = false;
                document.getElementById('hint-button').disabled = false;

                this.displayWord();
            },

            /**
             * Renders the current word state to the UI.
             */
            displayWord() {
                const data = this.gameData[this.currentWordIndex];
                if (!data) return;

                document.getElementById('current-word-index').textContent = this.currentWordIndex + 1;
                document.getElementById('word-definition').textContent = data.definition;
                document.getElementById('word-clue').textContent = data.clue;
                document.getElementById('word-image').src = data.imageUrl || `https://placehold.co/600x400/06B6D4/FFFFFF?text=Picture+Clue+Loading...`;
                document.getElementById('hints-remaining').textContent = this.maxHints - data.hintsUsed;
                document.getElementById('hint-button').disabled = data.hintsUsed >= this.maxHints;

                // Render the scrambled word and hint display
                const display = document.getElementById('scrambled-word-display');
                display.innerHTML = ''; 
                
                // Show letters of the scrambled word, marked with hints if applicable
                for (let i = 0; i < data.scrambled.length; i++) {
                    const charSpan = document.createElement('span');
                    charSpan.className = 'scrambled-char';
                    
                    if (data.currentGuess[i] !== '_') {
                        // Display the correctly guessed/hinted letter
                        charSpan.textContent = data.currentGuess[i];
                        charSpan.classList.add('hint-letter');
                    } else {
                        // Display the scrambled letter, which serves as a prompt for the child
                        charSpan.textContent = data.scrambled[i];
                    }
                    display.appendChild(charSpan);
                }
                
                // Clear input field for the new word
                document.getElementById('word-input').value = '';
                this.clearMessageBox();
            },

            /**
             * Checks the user's guess against the original word.
             */
            checkGuess() {
                const inputField = document.getElementById('word-input');
                const guess = inputField.value.trim().toUpperCase();
                const data = this.gameData[this.currentWordIndex];

                if (!guess) {
                    this.showMessage("Please type your best guess in the box!", 'bg-yellow-200 text-yellow-800 border-2 border-amber-400');
                    return;
                }

                if (guess === data.original) {
                    // Correct Guess!
                    data.isCorrect = true;
                    const points = this.calculatePoints(data.hintsUsed);
                    this.score += points;
                    this.updateScoreDisplay();
                    
                    // Fixed messaging using HTML instead of markdown
                    this.showMessage(`
                        <span class="text-3xl">üéâ</span> You Got It! You earned <span class="text-xl font-extrabold">${points}</span> points. The word was <span class="text-emerald-800 font-extrabold text-2xl">${data.original}</span>!
                    `, 'bg-emerald-200 text-emerald-800 border-2 border-emerald-400');
                    
                    inputField.value = '';
                    setTimeout(() => this.nextWord(), 2500);
                } else {
                    // Incorrect Guess
                    this.showMessage(`‚ùå Oops! That's not quite right. Try looking at the letters and clues again!`, 'bg-red-200 text-red-800 border-2 border-red-400');
                    inputField.value = '';
                }
                inputField.focus();
            },

            /**
             * Calculates points based on hints used.
             */
            calculatePoints(hintsUsed) {
                const penaltyPerHint = Math.floor(this.basePoints / (this.maxHints + 1));
                return Math.max(0, this.basePoints - (hintsUsed * penaltyPerHint));
            },

            /**
             * Reveals one correct letter as a hint.
             */
            applyHint() {
                const data = this.gameData[this.currentWordIndex];
                if (data.hintsUsed >= this.maxHints) {
                    this.showMessage("Sorry, you've used all your hints for this word!", 'bg-red-200 text-red-800 border-2 border-red-400');
                    return;
                }

                let foundHint = false;
                // Find the first undiscovered letter position
                for (let i = 0; i < data.original.length; i++) {
                    if (data.currentGuess[i] === '_') {
                        // Apply hint
                        const correctLetter = data.original[i];
                        data.currentGuess = data.currentGuess.substring(0, i) + correctLetter + data.currentGuess.substring(i + 1);
                        data.hintsUsed++;
                        foundHint = true;
                        break;
                    }
                }

                if (foundHint) {
                    this.showMessage(`‚≠ê A helpful letter appeared! You have <span class="font-extrabold">${this.maxHints - data.hintsUsed}</span> hints left.`, 'bg-sky-200 text-sky-800 border-2 border-sky-400');
                    this.displayWord(); // Re-render to show the hint
                    document.getElementById('word-input').focus();
                } else {
                    this.showMessage("Great job! You've already found all the letters with your hints.", 'bg-yellow-200 text-yellow-800 border-2 border-amber-400');
                }
            },

            /**
             * Advances to the next word or ends the game.
             */
            async nextWord() {
                this.currentWordIndex++;
                if (this.currentWordIndex < this.words.length) {
                    await this.fetchDataForCurrentWord();
                    this.displayWord();
                } else {
                    this.endGame();
                }
            },

            /**
             * Shows the game over screen.
             */
            endGame() {
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('game-over-screen').classList.remove('hidden');
                document.getElementById('final-score').textContent = this.score;

                const reviewList = document.getElementById('review-list');
                reviewList.innerHTML = ''; // Clear previous content

                this.gameData.forEach(data => {
                    const statusIcon = data.isCorrect ? '‚úÖ Solved!' : 'üí° Keep Thinking!';
                    const hints = data.hintsUsed;
                    reviewList.innerHTML += `<p class="mb-2 p-3 rounded-xl border ${data.isCorrect ? 'bg-emerald-50 text-emerald-800 border-emerald-300' : 'bg-red-50 text-red-800 border-red-300'}">
                        <span class="font-extrabold text-lg">${data.original}</span>: ${statusIcon} (Hints Used: ${hints})<br>
                        <span class="text-sm italic">${data.definition}</span>
                    </p>`;
                });
            },

            /**
             * Updates the score displayed on the game screen.
             */
            updateScoreDisplay() {
                document.getElementById('current-score').textContent = this.score;
            },

            /**
             * Displays a transient message in the message box.
             */
            showMessage(message, classes) {
                const box = document.getElementById('message-box');
                box.textContent = ''; // Clear previous content
                box.innerHTML = message;
                box.className = `mt-6 p-4 text-center rounded-xl font-semibold text-xl shadow-inner ${classes}`;
                box.classList.remove('hidden');
            },

            /**
             * Clears the message box.
             */
            clearMessageBox() {
                document.getElementById('message-box').classList.add('hidden');
            }
        };

        // Initialize the app on window load
        window.onload = App.initializeApp.bind(App);
    </script>
</body>
</html>
